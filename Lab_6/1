import xml.etree.ElementTree as ET
import matplotlib.pyplot as plt
from collections import Counter
import numpy as np
def load_users_data():
    """Загружает данные о пользователях из users.xml"""
    try:
        users_tree = ET.parse('users.xml')
        users = []
        for user_elem in users_tree.getroot().findall('user'):
            user = {
                'user_id': int(user_elem.find('user_id').text),
                'name': user_elem.find('name').text,
                'age': int(user_elem.find('age').text),
                'weight': int(user_elem.find('weight').text),
                'fitness_level': user_elem.find('fitness_level').text,
                'workouts': []
            }
            users.append(user)
        return users
    except FileNotFoundError:
        print("Файл users.xml не найден")
        return []
def load_workouts_data():
    """Загружает данные о тренировках из workouts.xml"""
    try:
        workouts_tree = ET.parse('workouts.xml')
        workouts = []
        for workout_elem in workouts_tree.getroot().findall('workout'):
            workout = {
                'workout_id': int(workout_elem.find('workout_id').text),
                'user_id': int(workout_elem.find('user_id').text),
                'date': workout_elem.find('date').text,
                'type': workout_elem.find('type').text,
                'duration': int(workout_elem.find('duration').text),
                'distance': float(workout_elem.find('distance').text),
                'calories': int(workout_elem.find('calories').text),
                'avg_heart_rate': int(workout_elem.find('avg_heart_rate').text),
                'intensity': workout_elem.find('intensity').text
            }
            workouts.append(workout)
        return workouts
    except FileNotFoundError:
        print("Файл workouts.xml не найден")
        return []
def get_stats(users, workouts):
    """Выводит общую статистику"""
    total_workouts = len(workouts)
    total_users = len(users)
    total_calories = sum(workout['calories'] for workout in workouts)
    total_hours = sum(workout['duration'] for workout in workouts) / 60
    total_distance = sum(workout['distance'] for workout in workouts)

    print("ОБЩАЯ СТАТИСТИКА")
    print("===========================")
    print(f"Всего тренировок: {total_workouts}")
    print(f"Всего пользователей: {total_users}")
    print(f"Сожжено калорий: {total_calories}")
    print(f"Общее время: {total_hours:.1f} часов")
    print(f"Пройдено дистанции: {total_distance:.1f} км")
def analyze_user_activity(users):
    """Анализирует активность пользователей и выводит топ-3"""
    # Связываем тренировки с пользователями
    workouts = load_workouts_data()
    for user in users:
        user_workouts = [w for w in workouts if w['user_id'] == user['user_id']]
        user['workouts'] = user_workouts

    # Считаем статистику для каждого пользователя
    user_stats = []
    for user in users:
        workouts_count = len(user['workouts'])
        if workouts_count > 0:
            total_calories = sum(w['calories'] for w in user['workouts'])
            total_hours = sum(w['duration'] for w in user['workouts']) / 60
            user_stats.append({
                'name': user['name'],
                'fitness_level': user['fitness_level'],
                'workouts': workouts_count,
                'calories': total_calories,
                'hours': total_hours
            })

    # Сортируем по количеству тренировок
    user_stats.sort(key=lambda x: x['workouts'], reverse=True)
    print("\nТОП-3 АКТИВНЫХ ПОЛЬЗОВАТЕЛЕЙ:")
    for i, stat in enumerate(user_stats[:3], 1):
        print(f"  {i}. {stat['name']} ({stat['fitness_level']}):")
        print(f"   Тренировок: {stat['workouts']}")
        print(f"   Калорий: {stat['calories']}")
        print(f"   Время: {stat['hours']:.1f} часов")
def analyze_workout_types(workouts):
    """Анализирует распределение по типам тренировок"""
    type_stats = Counter()
    type_details = {}

    for workout in workouts:
        workout_type = workout['type']
        type_stats[workout_type] += 1

        if workout_type not in type_details:
            type_details[workout_type] = {'duration': [], 'calories': []}
        type_details[workout_type]['duration'].append(workout['duration'])
        type_details[workout_type]['calories'].append(workout['calories'])

    total_workouts = len(workouts)
    print("\nРАСПРЕДЕЛЕНИЕ ПО ТИПАМ ТРЕНИРОВОК:")
    for workout_type, count in type_stats.most_common():
        percentage = (count / total_workouts) * 100
        avg_duration = np.mean(type_details[workout_type]['duration'])
        avg_calories = np.mean(type_details[workout_type]['calories'])
        print(f"  {workout_type}: {count} тренировок ({percentage:.1f}%)")
        print(f"    Средняя длительность: {avg_duration:.0f} мин")
        print(f"    Средние калории: {avg_calories:.0f} ккал")
def find_user_workouts(users, user_name):
    """Находит тренировки пользователя по имени"""
    user = next((u for u in users if u['name'].lower() == user_name.lower()), None)
    if user:
        return [w for w in user['workouts']]
    return []
def analyze_user(user, workouts):
    """Детальный анализ тренировок пользователя"""
    if not workouts:
        print(f"Тренировки для пользователя {user['name']} не найдены")
        return

    total_workouts = len(workouts)
    total_calories = sum(w['calories'] for w in workouts)
    total_hours = sum(w['duration'] for w in workouts) / 60
    total_distance = sum(w['distance'] for w in workouts)
    avg_calories = total_calories / total_workouts if total_workouts > 0 else 0

    # Самый популярный тип тренировки
    type_counts = Counter(w['type'] for w in workouts)
    favorite_type = type_counts.most_common(1)[0][0] if type_counts else "Нет данных"

    print(f"\nДЕТАЛЬНЫЙ АНАЛИЗ ДЛЯ ПОЛЬЗОВАТЕЛЯ: {user['name']}")
    print("===========================================")
    print(f"Возраст: {user['age']} лет, Вес: {user['weight']} кг")
    print(f"Уровень: {user['fitness_level']}")
    print(f"Тренировок: {total_workouts}")
    print(f"Сожжено калорий: {total_calories}")
    print(f"Общее время: {total_hours:.1f} часов")
    print(f"Пройдено дистанции: {total_distance:.1f} км")
    print(f"Средние калории за тренировку: {avg_calories:.0f}")
    print(f"Любимый тип тренировки: {favorite_type}")
